<style>
    .suggestions-box {
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    position: absolute;
    width: 100%;
    background-color: white;
    z-index: 999;
    display: none; /* Initially hidden */
}

.suggestions-box div {
    padding: 8px;
    cursor: pointer;
}

.suggestions-box div:hover {
    background-color: #ddd;
}

</style>
<form id="SellForm" action="https://script.google.com/macros/s/AKfycbzc7xWF-Yq7dtW5CnQ_5-95dleOzHxhEC9HofTdt7Wm1ReN9xWOr8wJmB8Yo4tNjbfPaQ/exec?function=postSellData" method="post">
    <table id="Sell">
        <thead>
            <tr>
                <th>#</th>
                <th>Product Name</th>
                <th>Product ID</th>
                <th>Current Stock</th>
                <th>Quantity</th>
                <th>Unit Price ($)</th>
                <th>Total Price ($)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <tr id="row1">
                <td>1</td>
                <td>
                    <input type="text" name="product_name[]" id="productInput1" oninput="showProductSuggestions(this)" autocomplete="off" required>
                    <div id="productSuggestions1" class="suggestions-box"></div> <!-- Suggestions box -->
                </td>
                <td><input type="text" name="product_id[]" required readonly></td>
                <td><input type="text" name="current_stock[]" readonly></td>
                <td><input type="number" name="sell_quantity[]" required onchange="calculateTotal(this)"></td>
                <td><input type="number" name="sell_price[]" value="0" onchange="calculateTotal(this)"></td>
                <td><input type="text" name="total_price[]" readonly></td>
                <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">Remove</button></td>
            </tr>
        </tbody>
    </table>
    <button type="button" class="btn" onclick="addRow()">Add Row</button>
    <button type="submit" class="btn btn-primary">Submit</button>
</form>


<script>
    // Constants
const apiKey = "AIzaSyD7eX6VGCDHXBzF63CAHDfaP1-WFp3jcoI";
const spreadsheetId = "1lLzGvnJBQKPFpRPSRYjb_Q6N80G9mB_7_sLPR-0N5Ng";
const productRange = "Products!B2:C";
const stockRange = "Stock!A:F";

let productData = [];

// Fetch product data and store it in memory
function fetchProductData() {
    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${productRange}?key=${apiKey}`)
        .then(response => response.json())
        .then(data => {
            productData = data.values.map(row => ({ id: row[0], name: row[1] }));
            initializeFirstRow(); // Initialize first row after fetching data
        })
        .catch(error => console.error("Error fetching product list:", error));
}

// Show product suggestions as the user types
function showProductSuggestions(input) {
    const searchTerm = input.value.toLowerCase();
    const suggestionBox = document.getElementById(input.id.replace('productInput', 'productSuggestions')); // Find corresponding suggestion box
    suggestionBox.innerHTML = ''; // Clear previous suggestions
    suggestionBox.style.display = 'none'; // Hide suggestions if input is empty

    if (searchTerm === '') return; // Do not show suggestions if the input is empty

    // Filter products based on the input value
    const filteredProducts = productData.filter(product =>
        product.name.toLowerCase().includes(searchTerm)
    );

    if (filteredProducts.length > 0) {
        suggestionBox.style.display = 'block'; // Show suggestions if available
        filteredProducts.forEach(product => {
            const suggestion = document.createElement('div');
            suggestion.textContent = product.name;
            suggestion.onclick = () => selectProduct(input, product); // Select product when clicked
            suggestionBox.appendChild(suggestion);
        });
    }
}

// Select product from suggestions and populate the row
function selectProduct(input, product) {
    input.value = product.name; // Set product name in the input field
    const row = input.closest('tr'); // Find the corresponding row
    row.querySelector('input[name="product_id[]"]').value = product.id; // Set product ID
    fetchProductStock(product.id, row); // Fetch and set stock data
    input.nextElementSibling.style.display = 'none'; // Hide suggestions box
}

// Fetch and set stock data for the selected product
function fetchProductStock(productId, row) {
    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${stockRange}?key=${apiKey}`)
        .then(response => response.json())
        .then(data => {
            const stockRow = data.values.find(row => row[0] === productId);
            const stockQuantity = stockRow ? stockRow[5] : "0";
            row.querySelector('input[name="current_stock[]"]').value = stockQuantity;
        })
        .catch(error => console.error("Error fetching stock data:", error));
}

// Add a new row to the Sell table
function addRow() {
    const table = document.getElementById("Sell");
    const rowCount = table.rows.length;
    const row = table.insertRow(rowCount);

    const serialNumber = rowCount; // Dynamic serial number

    // Insert cells into the new row
    row.insertCell(0).textContent = serialNumber;
    row.insertCell(1).innerHTML = `
        <input type="text" name="product_name[]" id="productInput${rowCount}" oninput="showProductSuggestions(this)" autocomplete="off" required>
        <div id="productSuggestions${rowCount}" class="suggestions-box"></div> <!-- Suggestions box -->
    `;
    row.insertCell(2).innerHTML = '<input type="text" name="product_id[]" required readonly>';
    row.insertCell(3).innerHTML = '<input type="text" name="current_stock[]" readonly>';
    row.insertCell(4).innerHTML = '<input type="number" name="sell_quantity[]" required oninput="calculateTotal(this)">';
    row.insertCell(5).innerHTML = '<input type="number" name="sell_price[]" readonly value="0" oninput="calculateTotal(this)">';
    row.insertCell(6).innerHTML = '<input type="text" name="total_price[]" readonly>';
    row.insertCell(7).innerHTML = '<button type="button" class="btn btn-danger" onclick="removeRow(this)">Remove</button>';
}

// Remove a row from the Sell table
function removeRow(button) {
    const row = button.closest("tr");
    row.parentNode.removeChild(row);

    // Update serial numbers
    const table = document.getElementById("Sell");
    for (let i = 1; i < table.rows.length; i++) {
        table.rows[i].cells[0].textContent = i;
    }
}

// Calculate total price for a single row
function calculateTotal(input) {
    const row = input.closest("tr");
    const quantity = parseFloat(row.querySelector('input[name="sell_quantity[]"]').value) || 0;
    const price = parseFloat(row.querySelector('input[name="sell_price[]"]').value) || 0;
    const total = quantity * price;
    row.querySelector('input[name="total_price[]"]').value = total.toFixed(2);
}

// Initialize the first row
function initializeFirstRow() {
    const firstRow = document.getElementById("row1");
    const productInput = firstRow.querySelector('input[name="product_name[]"]');
    productInput.oninput = () => showProductSuggestions(productInput);
}

// Handle form submission with spinner and popup
document.addEventListener("DOMContentLoaded", () => {
    fetchProductData(); // Load product data once

    document.getElementById('SellForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent form submission

        // Create the loading spinner
        const spinner = document.createElement('div');
        spinner.classList.add('spinner');
        document.body.appendChild(spinner);

        // Submit form data asynchronously
        const formData = new FormData(this);
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.body.removeChild(spinner); // Remove spinner
            if (data.success) {
                // Show success popup
                const successBox = document.createElement('div');
                successBox.classList.add('popup');
                successBox.innerHTML = '<p>Sell added successfully.</p>';

                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.onclick = () => window.location.reload();
                successBox.appendChild(okButton);

                document.body.appendChild(successBox);
            } else {
                // Show error popup
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            document.body.removeChild(spinner); // Remove spinner
            alert("Error submitting form.");
        });
    });
});

</script>